# 微信机器人项目 (gui-WeChatBot)

[![Python](https://img.shields.io/badge/Python-3.8%2B-blue?logo=python&logoColor=white)](https://www.python.org)

这是一个基于 **PaddleOCR** 和 **DeepSeek API** 的微信聊天机器人。它能自动识别微信群聊中 `@` 自己的消息并进行回复，同时支持多角色切换。注意：此机器人仅在微信窗口未最小化时工作。

---

## 项目结构及文件功能详解

### 核心文件

-   `main.py`: 程序入口文件。
    -   导入 `WeChatBot` 类并创建实例。
    -   启动机器人运行。
-   `bot.py`: 机器人主逻辑实现。
    -   整合各个模块功能。
    -   实现 `WeChatBot` 类，包含初始化、检测触发、发送消息和运行主循环等方法。
    -   处理 `@` 消息的检测、提取问题内容。
    -   管理窗口状态（最小化/恢复）。
    -   实现消息发送功能（复制、粘贴、发送）。
    -   防止重复回复同一问题。
-   `config.py`: 配置文件。
    -   定义 `Config` 类，包含所有配置参数。
    -   设置日志记录器。
    -   加载所有角色配置。
    -   配置 DeepSeek API 密钥和 URL。
    -   设置微信窗口参数和位置。
    -   配置聊天历史相关参数。
    -   提供根据角色获取系统提示词的方法。

### `utils/` 目录 (工具模块)

-   `utils/api_client.py`: DeepSeek API 客户端。
    -   实现 `APIClient` 类，处理与 DeepSeek API 的交互。
    -   生成回复功能，包含系统提示词和聊天历史。
    -   错误处理和异常捕获。
-   `utils/chat_history.py`: 聊天历史管理。
    -   实现 `ChatHistoryManager` 类，管理聊天历史记录。
    -   支持角色切换，保存和加载不同角色的历史记录。
    -   提供添加新对话、获取最近历史的方法。
    -   实现问题相似度检测，避免回答重复问题。
    -   自动保存对话历史到 JSON 文件。
-   `utils/ocr_handler.py`: OCR 文字识别处理。
    -   实现 `OCRHandler` 类，使用 PaddleOCR 进行文字识别。
    -   提供图像中文字识别功能。
    -   判断文本行之间的位置关系。
    -   根据置信度阈值过滤识别结果。
-   `utils/window_manager.py`: 微信窗口管理。
    -   实现 `WindowManager` 类，处理微信窗口操作。
    -   查找微信窗口、获取窗口位置和大小。
    -   检测窗口状态（最小化/正常）。
    -   实现窗口截图功能（仅在窗口未最小化时）。
    -   提供点击聊天输入框的方法。

### `roles/` 目录 (角色配置)

-   `roles/__init__.py`: 角色配置加载模块。
    -   提供 `load_all_roles` 函数，加载所有角色配置。
    -   验证角色配置的有效性。
    -   记录角色加载状态。
-   `roles/manager.py`: 角色管理工具 (命令行)。
    -   提供命令行界面管理角色配置。
    -   实现列出、添加、编辑和删除角色的功能。
    -   处理角色配置文件的读写操作。
    -   提供交互式角色编辑界面。
-   `roles/*.json`: 具体的角色配置文件。

### `chat_histories/` 目录

-   保存各角色的聊天历史记录 (已被 `.gitignore` 忽略)。
    -   每个角色对应一个 JSON 文件，存储聊天历史。
    -   格式化保存发送者、问题、回复和时间戳。

---

## 功能特点

1.  **多角色支持**:
    -   支持多种预设角色（如 `夸夸机bot`、`丰川祥子bot` 等）。
    -   每个角色拥有独立的系统提示词和聊天历史。
    -   可通过 `@机器人别名` 触发不同角色。
    -   支持通过 `roles/manager.py` 工具动态管理角色。
2.  **自动回复**:
    -   使用 PaddleOCR 识别屏幕文字。
    -   智能提取 `@` 消息和问题内容。
    -   调用 DeepSeek API 生成回复。
    -   仅在微信窗口未最小化时工作，最小化时会跳过截图并记录日志。
3.  **聊天历史**:
    -   自动保存每个角色的聊天记录到 `chat_histories/` 目录。
    -   限制内存中保存的对话轮数以优化性能。
    -   支持问题相似度检测，避免回答重复问题。
    -   为 API 请求提供上下文，提高回复质量。
4.  **窗口管理**:
    -   支持微信窗口的查找、截图和状态检测。
    -   在微信窗口未最小化时自动截图识别消息。
    -   自动点击聊天输入框并发送消息。

---

## 使用说明

1.  **环境准备**:
    -   安装 Python 3.8 或更高版本。
    -   安装 PaddleOCR 及其依赖。**注意**: PaddleOCR 的环境配置可能较为复杂，请参考其官方文档进行安装。

2.  **安装依赖**:
    克隆仓库后，在项目根目录下运行：
    ```bash
    pip install -r requirements.txt
    ```

3.  **配置 `config.py`**:
    -   设置你的 DeepSeek API 密钥 (`DEEPSEEK_API_KEY`)。
    -   根据需要调整微信窗口名称 (`WECHAT_WINDOW_TITLE`) 和截图区域 (`CHAT_AREA_BOX`, `INPUT_BOX_POS`) 等参数。

4.  **运行**:
    ```bash
    python main.py
    ```

5.  **触发回复**:
    在微信群聊中 `@` 机器人的指定名称（或其别名）并提问即可。

---

## 注意事项

-   确保 PaddleOCR 环境已正确安装并能正常工作。
-   微信窗口标题需要与 `config.py` 中的 `WECHAT_WINDOW_TITLE` 设置完全匹配。
-   首次使用或更换显示器/分辨率后，可能需要调整 `config.py` 中的窗口位置和截图区域参数。
-   可以通过 `roles/manager.py` 工具方便地管理角色配置。
