# 微信机器人项目

这是一个基于OCR和DeepSeek API的微信机器人，能够自动识别微信群聊中的@消息并回复，支持多角色切换和窗口最小化操作。

## 项目结构及文件功能详解

### 核心文件

- **main.py**: 程序入口文件
  - 导入WeChatBot类并创建实例
  - 启动机器人运行

- **bot.py**: 机器人主逻辑实现
  - 整合各个模块功能
  - 实现WeChatBot类，包含初始化、检测触发、发送消息和运行主循环等方法
  - 处理@消息的检测、提取问题内容
  - 管理窗口状态（最小化/恢复）
  - 实现消息发送功能（复制、粘贴、发送）
  - 防止重复回复同一问题

- **config.py**: 配置文件
  - 定义Config类，包含所有配置参数
  - 设置日志记录器
  - 加载所有角色配置
  - 配置DeepSeek API密钥和URL
  - 设置微信窗口参数和位置
  - 配置聊天历史相关参数
  - 提供根据角色获取系统提示词的方法

### utils目录

- **utils/api_client.py**: DeepSeek API客户端
  - 实现APIClient类，处理与DeepSeek API的交互
  - 生成回复功能，包含系统提示词和聊天历史
  - 错误处理和异常捕获

- **utils/chat_history.py**: 聊天历史管理
  - 实现ChatHistoryManager类，管理聊天历史记录
  - 支持角色切换，保存和加载不同角色的历史记录
  - 提供添加新对话、获取最近历史的方法
  - 实现问题相似度检测，避免回答重复问题
  - 自动保存对话历史到JSON文件

- **utils/ocr_handler.py**: OCR文字识别处理
  - 实现OCRHandler类，使用PaddleOCR进行文字识别
  - 提供图像中文字识别功能
  - 判断文本行之间的位置关系
  - 根据置信度阈值过滤识别结果

- **utils/window_manager.py**: 微信窗口管理
  - 实现WindowManager类，处理微信窗口操作
  - 查找微信窗口、获取窗口位置和大小
  - 支持窗口的恢复和最小化操作
  - 实现窗口截图功能，即使在最小化状态也能工作
  - 提供点击聊天输入框的方法

### roles目录

- **roles/__init__.py**: 角色配置模块
  - 提供load_all_roles函数，加载所有角色配置
  - 验证角色配置的有效性
  - 记录角色加载状态

- **roles/manager.py**: 角色管理工具
  - 提供命令行界面管理角色配置
  - 实现列出、添加、编辑和删除角色的功能
  - 处理角色配置文件的读写操作
  - 提供交互式角色编辑界面

### 其他目录

- **chat_histories/**: 保存各角色的聊天历史记录
  - 每个角色对应一个JSON文件，存储聊天历史
  - 格式化保存发送者、问题、回复和时间戳

## 功能特点

1. **多角色支持**:
   - 支持多种预设角色，如夸夸机bot、丰川祥子bot等
   - 每个角色有独立的系统提示词和聊天历史
   - 可通过别名触发不同角色
   - 支持通过manager.py工具动态管理角色

2. **自动回复**:
   - 通过PaddleOCR识别屏幕文字
   - 智能提取@消息和问题内容
   - 调用DeepSeek API生成回复
   - 支持窗口最小化状态下的监控和回复

3. **聊天历史**:
   - 自动保存每个角色的聊天记录
   - 限制内存中保存的对话轮数
   - 支持问题相似度检测，避免回答重复问题
   - 为API请求提供上下文，提高回复质量

4. **窗口管理**:
   - 支持微信窗口的查找、截图、恢复和最小化
   - 即使在窗口最小化状态也能正常工作
   - 自动点击聊天输入框并发送消息

## 使用说明

1. 安装依赖:
```bash
pip install -r requirements.txt
```

2. 配置`config.py`:
   - 设置DeepSeek API密钥
   - 调整微信窗口名称和位置参数

3. 运行:
```bash
python main.py
```

4. 在微信群聊中@机器人触发回复

## 注意事项

- 需要安装PaddleOCR相关依赖
- 微信窗口标题需要与config.py中的设置匹配
- 首次使用需要调整窗口位置参数
- 可通过roles/manager.py工具管理角色配置
